<!DOCTYPE html>
<html>
  <head>
    <script src="js/jquery-1.9.0.min.js" type="text/javascript"></script>
    <script src="js/underscore-min.js" type="text/javascript"></script>
    <script src="js/plant-cross.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="css/style.css">        
    <title>Plant Crossing</title>
  </head>
  <body>
    <section id="parents" class="clearfix">
      <h2>Parents</h2>
    </section>
    
    <script type="text/template" id="cross-template">
      <section class="cross clearfix" id="cross-<%= id %>" data-id="<%= id %>">
        <h2>Cross <%= id %></h2>
        <div class="content clearfix">
          <div class="instructions">
            <p>Select two plants</p>  
            <button>Cross</button>        
          </div>
        </div>
      </section>
    </script>
    
    <script type="text/template" id="plant-template">
      <div class="plant clearfix">   
        <div class="plant-pic">
          <img src="img/<%= img %>" width="140" />
        </div>
        <div class="plant-data">
          <h4><%= name %></h4>
          <p>Root coloration: <%= rootColor() %></p>
          <p>Leaf Hairiness: <%= hairiness() %></p>
          <p>Root Size: <%= dmy %> </p>
          <p>Branching Tendency: <%= branching %> </p>
          <p>Whitefly Resistance: <%= flyResistance() %> </p>
          <p>Virus Resistance: <%= virusResistance() %> </p>
          <p>Cyanide Content: <%= cyanide() %></p>
        </div>
      </div>
    </script>
    
    <script type="text/javascript">         
      var plantTemplate = _.template($('#plant-template').html());  
      var crossTemplate = _.template($('#cross-template').html());
      var $body = $('body');
      var $parents = $('#parents');
      _.each(parents, function(plant){
          var $parent = $($.trim(plantTemplate(plant))).appendTo($parents);
          $parent.data('plant', plant);
      });
      
      var $activeCross = $($.trim(crossTemplate({id: 1}))).appendTo($body);
      var $lastClicked;
      
      $('body').on('click', '.plant', function(){
        var $this = $(this);        
        if ($this.hasClass('active')) {
          $this.removeClass('active');          
        } else {
          var activePlants = $('.plant.active').length;
          if (activePlants == 2) {
            $lastClicked.removeClass('active');
          } 
          $lastClicked = $this;
          $this.addClass('active');
        } 
      });
      
      $('body').on('click', 'button', function(){
        var $activePlants = $('.plant.active');
        if ($activePlants.length !== 2) {
          return alert('You must select two plants');
        }
        
        var plant1 = $activePlants.first().data('plant');
        var plant2 = $activePlants.last().data('plant');
        var offspring = plant1.crossWith(plant2);
        
        var parentDivs = addDivs([plant1, plant2]);
        var offspringDivs = addDivs(offspring);
        $activeCross.find('.content').html('<div class="parents"><h3>Parents</h3></div><div class="offspring"><h3>Offspring</h3></div>');
        $activeCross.find('.parents').append(parentDivs);
        $activeCross.find('.offspring').append(offspringDivs);
        
        var $crosses = $('.cross');
        if ($crosses.length === 5) return;
        
        $activeCross = $($.trim(crossTemplate({id: $crosses.length+1}))).appendTo($body);
      });
      
      function addDivs(plants) {
        var $divs = [];
        _.each(plants, function(p){
          var $d = $($.trim(plantTemplate(p)));
          $d.data('plant', p);
          $divs.push($d);
        });
        return $divs;
      }
    </script>    
  </body>
</html>